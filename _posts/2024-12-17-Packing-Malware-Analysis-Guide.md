---
title: 'π“‘ "Packing", Malware Analysis Guide'
date: 2024-12-17 21:00:00 +0900
categories: [Malware Analysis Guide]
tags: [malware_analysis_guide, packing]
render_with_liquid: falsed
---

ν¨ν‚Ήμ€ μ½”λ“λ¥Ό μ•”νΈν™”ν•κ±°λ‚ μ••μ¶•ν•μ—¬ μ›λ ν•νƒλ¥Ό μ¨κΈ°λ” κΈ°λ²•μ…λ‹λ‹¤. μ•…μ„±μ½”λ“λ” νƒμ§€λ¥Ό νν”Όν•κ³  λ¶„μ„μ„ μ–΄λ µκ² ν•κΈ° μ„ν•΄ ν¨ν‚Ήμ„ ν™μ©ν•©λ‹λ‹¤. ν¨ν‚Ήλ νμΌμ΄ μ‹¤ν–‰λλ©΄ μ–Έν¨ν‚Ή κ³Όμ •μ„ κ±°μΉκ² λλ”λ° ν•΄λ‹Ή κ³Όμ •μ—μ„ μ‚¬μ©λλ” APIλ¥Ό μ΄μ©ν•λ©΄ OriginalEntryPoint(OEP)λ¥Ό μ°Ύμ„ μ μμµλ‹λ‹¤.

## <mark>1. ν¨ν‚Ήλ νμΌ</mark>

### β– <u>μΌλ°μ μΈ μ‹¤ν–‰ λ‹¨κ³„</u>

1. λ©”λ¨λ¦¬ ν• λ‹Ή
2. νμ΄λ΅λ“ μ••μ¶• ν•΄μ 
3. μ„ν¬νΈ ν…μ΄λΈ” λ³µκµ¬
4. OEPλ΅ μ΄λ™
5. νμ΄λ΅λ“ μ‹¤ν–‰

### β– <u>μμ£Ό μ‚¬μ©λλ” NT APIμ™€ Win32 API</u>

| API   | Funcion                                                      |
| ----- | ------------------------------------------------------------ |
| Ntdll | LdrLoadDll, LdrGetProcedureAddress, NtAllocateVirtualMemory,<br />NtProtectVirtualMemory, NtFreeVirtualMemory, NtWriteFile, NtReadFile |
| Win32 | LoadLibrary, GetProcAddress, VirtualAlloc, VirtualProtect, VirtualFree, WriteFile, ReadFile |



## <mark>2. ν¨ν‚Ήλ νμΌ μ‹¤ν–‰</mark>

### 1) <u>λ©”λ¨λ¦¬ ν• λ‹Ή</u>

λ΅λ”λ” μ–Έν¨ν‚Ήλ νμ΄λ΅λ“λ¥Ό μ €μ¥ν•  λ©”λ¨λ¦¬λ¥Ό ν• λ‹Ήν•©λ‹λ‹¤. μΌλ°μ μΌλ΅ VirtualAlloc, HeapAlloc, GlobalAlloc, RtlAllocateHeap, NtAllocateVirtualMemoryμ™€ κ°™μ€ APIλ¥Ό μ—¬λ¬λ² νΈμ¶ν•μ—¬ μ½”λ“ λ° λ°μ΄ν„°λ¥Ό λ©”λ¨λ¦¬ μƒμ— λ°°μΉν•©λ‹λ‹¤. μΌλ¶€ λ΅λ”λ” ν¨μ»¤λ” μƒν”μ κΈ°μ΅΄ λ©”λ¨λ¦¬ κ³µκ°„μ„ λ®μ–΄μ“°κΈ°λ„ ν•©λ‹λ‹¤. μ΄λ° κ²½μ° λ©”λ¨λ¦¬ ν• λ‹Ή APIμ νΈμ¶μ΄ μ κ±°λ‚ μ—†μ„ μλ„ μμµλ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160206330-1734437013936-1.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160206330" style="zoom:80%;" />

### 2) <u>νμ΄λ΅λ“ μ••μ¶• ν•΄μ </u>

λ΅λ”λ” ν• λ‹Ήν• λ©”λ¨λ¦¬ μμ—­μ— μ••μ¶•λ νμ΄λ΅λ“λ¥Ό μ••μ¶• ν•΄μ  μ•κ³ λ¦¬μ¦μ„ μ‚¬μ©ν•΄ μ–Έν¨ν‚Ήν•©λ‹λ‹¤. μ‚¬μ©λλ” μ•κ³ λ¦¬μ¦μ€ λ‹¤μ–‘ν•λ©° Win32 API λ€μ‹  μ›μ‹ μ–΄μƒλΈ”λ¦¬ μ½”λ“λ§μ„ μ‚¬μ©ν•λ” κ²½μ°κ°€ μΌλ°μ μ…λ‹λ‹¤. μΌλ¶€ ν¨μ»¤λ” RtlDecompressBuffer APIλ¥Ό μ‚¬μ©ν•μ—¬ μ••μ¶•μ„ ν•΄μ ν•κΈ°λ„ ν•©λ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160206421-1734437029632-3.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160206421" style="zoom:80%;" />

### 3) <u>μ„ν¬νΈ ν…μ΄λΈ” λ³µκµ¬</u>

μ΄ν›„ μ–Έν¨ν‚Ήλ νμ΄λ΅λ“μ μ„ν¬νΈ ν…μ΄λΈ”μ„ μ½μ–΄ νμ΄λ΅λ“κ°€ μμ΅΄ν•λ” APIλ¥Ό μ°Ύμ•„λƒ…λ‹λ‹¤. LoadLibrary λλ” LdrLoadDllλ¥Ό μ‚¬μ©ν•μ—¬ ν•„μ”ν• Dllμ„ λ΅λ“ν•κ³ , GetProcAddress λλ” LdrGetProcedureAddressλ¥Ό μ‚¬μ©ν•΄ ν•„μ”ν• APIμ μ£Όμ†λ¥Ό νλ“ν•©λ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160209360-1734437040365-5.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160209360" style="zoom:80%;" />

### 4) <u>OEPλ΅ μ΄λ™</u>

OEPλ” λ΅λ”κ°€ μ–Έν¨ν‚Ήλ νμ΄λ΅λ“λ΅ μ‹¤ν–‰μ„ μ „λ‹¬ν•  λ• μ²« λ²μ§Έλ΅ μ‹¤ν–‰λΌμ•Ό ν•λ” λ…λ Ήμ μ£Όμ†μ…λ‹λ‹¤. ν¨μ»¤λ” μΌλ°μ μΌλ΅λ” JMPλ‚ CALL λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•μ—¬ μ μ–΄λ¥Ό λ„κΈ°λ”λ°, OEPκΉμ§€ λ„λ‹¬ν•λ”λ° μ—¬λ¬ λ‹¨κ³„μ μ••μ¶• ν•΄μ κ°€ ν•„μ”ν•  μ μκΈ° λ•λ¬Έμ— OEPμ— λ„λ‹¬ν–λ”μ§€ ν™•μΈν•κΈ° μ„ν•΄μ„λ” μ¶”κ°€μ μΈ ν™•μΈμ΄ ν•„μ”ν•©λ‹λ‹¤.

### 5) <u>νμ΄λ΅λ“ μ‹¤ν–‰</u>

λ‹¤μμ€ μ μ–΄κ¶μ΄ OEPμ— λ„μ°©ν•΄ νμ΄λ΅λ“μ— μλ”μ§€ ν™•μΈν•κΈ° μ„ν• API μ ν•μ…λ‹λ‹¤.

- λ””μ¤ν¬μ— μƒ νμΌ μƒμ„±
- νμΌμ— μ“°κΈ°
- λ μ§€μ¤νΈλ¦¬ ν‚¤ λ° κ°’ μƒμ„±
- λ„¤νΈμ›ν¬ μ—°κ²°
- μƒλ΅μ΄ ν”„λ΅μ„Έμ¤ μƒμ„±
- μ›κ²© ν”„λ΅μ„Έμ¤ μ—΄κΈ° λ° μ“°κΈ°
- μ›κ²© ν”„λ΅μ„Έμ¤μ—μ„ μ¤λ λ“ μƒμ„±

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160209422-1734437076160-7.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160209422" style="zoom:80%;" />

## <mark>3. λ””λ²„κ±°λ¥Ό μ‚¬μ©ν• μλ™ μ–Έν¨ν‚Ή</mark>

### β– <u>μλ™ μ–Έν¨ν‚Ή λ‹¨κ³„</u>

1. λ©”λ¨λ¦¬μ—μ„ μ••μ¶• ν•΄μ  λλ” μ–Έν¨ν‚Ήλ νμ΄λ΅λ“μ μ„μΉ νμ•…
2. νμ΄λ΅λ“λ¥Ό λ””μ¤ν¬μ— λ¤ν”„

#### 1) <u>νμ΄λ΅λ“μ μ„μΉ νμ•…</u>

RegCreateKeyExAλ¥Ό νΈμ¶ν•λ” νμ΄λ΅λ“ μ½”λ“ μ΄μ „μ— νΈμ¶λλ” LdrGetProcedureAddress APIμ νΈμ¶μ΄ μ„ν¬νΈ ν…μ΄λΈ” λ³µκµ¬ λ‹¨κ³„λΌκ³  μ¶”μ •ν•  μ μμµλ‹λ‹¤. κ·Έλ ‡λ‹¤λ©΄ LdrGetProcdureAddressμ™€ RegCreateKeyExAμ— OEPλ΅ JMPν•  κ°€λ¥μ„±μ΄ λ†’μµλ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160212759-1734437085942-9.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160212759" style="zoom:80%;" />

λ””λ²„κ±°μ μ΅°κ±΄λ¶€ μ¤‘λ‹¨μ μ„ ν™μ©ν•μ—¬ LdrGetProcedureAddressμ νλΌλ―Έν„°λ΅ CryptReleaseContextκ°€ μ „λ‹¬λ  λ•κΉμ§€ μ‹¤ν–‰ν•©λ‹λ‹¤. RegCreateKeyExAκ°€ μ‹¤ν–‰λκΈ°κΉμ§€ μ΄ 2λ²μ CryptReleaseContextλ¥Ό νλΌλ―Έν„°λ΅ κ°€μ§€λ” LdrGetProcedureAddressλ” μ΄ 2λ² μ‹¤ν–‰λλ―€λ΅ 2λ²μ§Έ νΈμ¶κΉμ§€ λ””λ²„κΉ…μ„ μ§„ν–‰ν•©λ‹λ‹¤.

```python
strstr(ansi([esp+0x10](esp+0x10)), "CryptReleaseContext")
```

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160212816-1734437105552-11.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160212816" style="zoom:80%;" />

BPκ°€ κ±Έλ¦° ν›„ λ””λ²„κΉ…μ„ μ§„ν–‰ν•λ©΄ LdrGetProcedureAddress APIλ¥Ό νΈμ¶ν• ν•¨μμ μ£Όμ†λ¥Ό μ• μ μμµλ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160215256-1734437113370-13.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160215256" style="zoom:80%;" />

μ΄λ²μ—λ” RegCreateKeyExAμ— BPλ¥Ό κ±Έκ³  λ””λ²„κΉ…μ„ μ§„ν–‰ν•©λ‹λ‹¤. λ§μ°¬κ°€μ§€λ΅ RegCreateKeyExAμ— BPκ°€ κ±Έλ¦° ν›„ λ””λ²„κΉ…μ„ μ§„ν–‰ν•μ—¬ ν•΄λ‹Ή APIκ°€ νΈμ¶λ ν•¨μ μ£Όμ†λ¥Ό νμ•…ν•©λ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160215319-1734437117573-15.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160215319" style="zoom:80%;" />

Memory Mapμ„ ν™•μΈν•΄λ³΄λ©΄ λ‘ μ£Όμ†λ” κΈ°μ΅΄ λ°”μ΄λ„λ¦¬μ ImageBaseκ°€ μ•„λ‹ 128000 λ©”λ¨λ¦¬ λΈ”λ΅μ—μ„ μ‹¤ν–‰λ κ²ƒμ„ μ• μ μμµλ‹λ‹¤. μ΄κ²ƒμ€ λ‘ ν•¨μ λ¨λ‘ μ–Έν¨ν‚Ήλ νμ΄λ΅λ“μ—μ„ μ‹¤ν–‰λμ—κ±°λ‚ μ•„μ§ μ–Έν¨ν‚Ή μ¤‘μ΄λΌκ³  ν•΄μ„ν•  μ μμµλ‹λ‹¤. ν•΄λ‹Ή λ©”λ¨λ¦¬ λΈ”λ΅μ μ‹μ‘λ¶€λ¶„μ΄ PE ν¬λ§·μ„ κ°€μ§€κ³  μλ” κ²ƒμΌλ΅ λ³΄μ•„ 128000 λ©”λ¨λ¦¬ λΈ”λ΅μ€ μ–Έν¨ν‚Ήλ νμ΄λ΅λ“μΌ ν™•λ¥ μ΄ λ†’μµλ‹λ‹¤.

![IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160217059](../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160217059-1734437125051-17.png)

![IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160218386](../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160218386-1734437129114-19.png)

μμ‹¬μ¤λ¬μ΄ λ‚΄λ¶€ λ¬Έμμ—΄ λν• ν™•μΈμ΄ κ°€λ¥ν–μµλ‹λ‹¤.

![IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160218449](../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160218449-1734437133773-21.png)

#### 2) <u>νμ΄λ΅λ“λ¥Ό λ””μ¤ν¬μ— λ¤ν”„</u>

μ–Έν¨ν‚Ήλ νμ΄λ΅λ“λ¥Ό μ°Ύμ•μ§€λ§, μ •ν™•ν• OEPμ μ„μΉλ” μ•„μ§ μ• μ μ—†μµλ‹λ‹¤. OllyDumpExμ Search κΈ°λ¥μ„ ν™μ©ν•λ©΄ μ΄λ―Έμ§€ μƒμ OEPλ¥Ό μ•λ ¤μ£ΌκΈ΄ ν•©λ‹λ‹¤λ§, PEκ°€ λ§μ΄ ν›Όμ†λ μƒνƒλΌλ©΄ μ •ν™•ν• OEPκ°€ μ•„λ‹ μλ„ μμµλ‹λ‹¤. κ·Έλ΄ κ²½μ° μ¶”κ°€μ μΈ λ¶„μ„μ„ ν†µν•΄ μ •ν™•ν• OEPλ¥Ό μ°Ύμ•„μ•Ό ν•©λ‹λ‹¤. ν•΄λ‹Ή κ³Όμ •μ—μ„ μλ» μ„ νƒλ μ„Ήμ…μ€ μ„ νƒ ν•΄μ  ν•΄μ¤μ•Ό ν•©λ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160219728-1734437142678-23.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160219728" style="zoom:67%;" />

![IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160219799](../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160219799-1734437154448-25.png)

μ •ν™•ν• OEPλ¥Ό ν™•μΈν•κΈ° μ„ν•΄μ„λ” λ¤ν”„ν• PEλ¥Ό IDA, Ghidraμ™€ κ°™μ€ μ •μ  λ¶„μ„ λ„κµ¬λ΅ λ‚΄λ¶€ μ½”λ“λ¥Ό ν™•μΈν•΄λ³΄κ±°λ‚ λ™μ  λ””λ²„κΉ…μ„ ν†µν•΄ μ½”λ“λ¥Ό ν•λ‚ν•λ‚ ν™•μΈν•΄λ΄μ•Ό ν•©λ‹λ‹¤. λ©€μ›¨μ–΄ μ¤‘μ—μ„λ” μ„ν¬νΈ ν…μ΄λΈ”μ΄λ‚ PE κµ¬μ΅°λ¥Ό μ‹¬ν•κ² ν›Όμ†ν•λ” κ²½μ°λ„ μ΅΄μ¬ν•λ―€λ΅ λ¤ν”„λ peκ°€ λ¬΄μ΅°κ±΄ μ‹¤ν–‰λλ¦¬λΌλ” λ³΄μ¥μ€ μ—†μµλ‹λ‹¤.

### β– <u>μλ™ OEP κ²€μƒ‰</u>

μλ¥Ό λ“¤μ–΄ NtAllocateVirtualMemoryλ¥Ό μ‚¬μ©ν•΄ μ–Έν¨ν‚Ή μ½”λ“λ¥Ό μ €μ¥ν•  0x20000 μ‚¬μ΄μ¦μ κ°€μƒ λ©”λ¨λ¦¬λ¥Ό ν• λ‹Ήλ°›λ” μ½”λ“μ— BPλ¥Ό μ„¤μΉν•©λ‹λ‹¤. ν•΄λ‹Ή μ½”λ“λ” μ–Έν¨ν‚Ή νμ΄λ΅λ“λ¥Ό μ €μ¥ν•  λ©”λ¨λ¦¬λ¥Ό ν• λ‹Ήλ°›λ” μ½”λ“μΌ ν™•λ¥ μ΄ λ†’μµλ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160221022-1734437160458-27.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160221022" style="zoom:80%;" />

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160221075-1734437163950-29.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160221075" style="zoom:80%;" />

BPκ°€ κ±Έλ¦° ν›„, λ””λ²„κΉ…μ„ ν•΄λ‚κ°€λ‹¤λ³΄λ©΄ μ–Έν¨ν‚Ήν•λ” λ¶€λ¶„μ„ ν™•μΈν•  μ μμµλ‹λ‹¤. κ·Έν›„μ— ν• λ‹Ήν• VMμΌλ΅ μ΄λ™ν•λ” μ½”λ“κ°€ μ΅΄μ¬ν•λ”λ° λ°ν™ μ£Όμ†λ¥Ό μ΅°μ‘ν•λ” λ°©μ‹μ„ μ΄μ©ν•λ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤.

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160222167-1734437167899-31.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160222167" style="zoom:80%;" />

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160223184-1734437172464-33.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160223184" style="zoom:80%;" />

μ–Έν¨ν‚Ήλ μ½”λ“ λΈ”λ΅μΌλ΅ μ΄λ™ν• ν›„μ—λ” νΉμ • ν•¨μ λ‚΄λ¶€λ΅ μ΄λ™ν•λ”λ° EPμ²λΌ λ³΄μ΄μ§€ μ•μΌλ―€λ΅ μΆ€ λ” μ§„ν–‰ν•λ‹¤λ³΄λ©΄ OEPμ²λΌ λ³΄μ΄λ” μ½”λ“κ°€ λ³΄μ…λ‹λ‹¤. OEPλ΅ μ¶”μ •λλ” μ„μΉμ— EIPλ¥Ό μ„μΉμ‹ν‚¤κ³  OllyDumpExμ Get EIP as OEP κΈ°λ¥μ„ μ‚¬μ©ν•΄ Dumpν•λ©΄ λ©λ‹λ‹¤.

![IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160223947](../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160223947-1734437203535-35.png)

<img src="../images/2024-12-17-Packing-Malware-Analysis-Guide/IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160224007-1734437208332-37.png" alt="IMG-ν¨ν‚Ή μ½”λ“ λ¶„μ„-20240818160224007" style="zoom:67%;" />