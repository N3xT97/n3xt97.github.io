---
title: '📑 "CyberChef", Malware Analysis Guide'
date: 2024-12-22 21:00:00 +0900
categories: [Malware Analysis Guide]
tags: [malware_analysis_guide, cyberchef]
render_with_liquid: falsed
---

공격자들은 악성 행위를 숨기기 위해, 잘 알려진 암호를 사용하여 문자열 및 코드를 암호화하기도 합니다. 이때, **CyberChef** 도구를 사용하면 추가적인 코딩없이 간단하게 암호화를 해결할 수 있습니다.

## <mark>1. CyberChef</mark>

다양한 암호화를 지원하는 분석툴로 온라인, 오프라인 환경에서 모두 이용 가능.

> [!NOTE]
> 
> 🔗 [CyberChef](https://github.com/gchq/CyberChef)



## <mark>2.  샘플 분석 (AES 복호화)</mark>

### ▪ <u>AES 정보 확인</u>

DotNet 샘플 내부에서 AES 암호화를 사용하는 것이 확인되었습니다. 또한, 코드 상에서 AES 복호화에 필요한 KeySize, BlockSize, CipherMode, PaddingMode 정보를 확인할 수 있었습니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919171545973-1734831152273-1.png" alt="IMG-CyberChef를 사용한 복호화-20240919171545973" style="zoom:80%;" />

CyberChef는 PaddingMode가 PKCS7인 AES Decrypt를 지원하므로, CyberChef를 사용해서 복호화 해보겠습니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919172040842-1734831158396-3.png" alt="IMG-CyberChef를 사용한 복호화-20240919172040842" style="zoom:80%;" />

### ▪ <u>AES Key 구하기</u>

먼저 AES Encrypt Key를 확인하기 위해 thIxrsJXpU가 어디서 Assign되는지 확인합니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919172254090-1734831497555-9.png" alt="IMG-CyberChef를 사용한 복호화-20240919172254090" style="zoom:80%;" />

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919172140728.png" alt="IMG-CyberChef를 사용한 복호화-20240919172140728" style="zoom:80%;" />

AES Key는 rLbmKwyrUDcRYd라는 함수 내에서 Rfc2898DeriveBytes API에 의해서 생성되는 것이 확인되었습니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919172422588.png" alt="IMG-CyberChef를 사용한 복호화-20240919172422588" style="zoom:80%;" />

암호 기반 키 파생 기능인 PBKDF2를 구현하는 API로 CyberChef에서 지원하는 알고리즘입니다. CyberChef를 사용하기 위해서는 Rfc2898DeriveBytes에 대한 추가적인 정보가 필요합니다.

> [!NOTE]
> 
> 🔗 [Rfc2898DeriveBytes](https://learn.microsoft.com/ko-kr/dotnet/api/system.security.cryptography.rfc2898derivebytes?view=net-8.0)

```c#
public Rfc2898DeriveBytes (byte[] password, byte[] salt, int iterations);
```

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919172919002.png" alt="IMG-CyberChef를 사용한 복호화-20240919172919002" style="zoom:80%;" />

코드 상에서 Rfc2898DeriveBytes는 SHA1 알고리즘을 사용하며, 전달되는 반복 횟수는 50000이라는 것을 알 수 있습니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919173949065.png" alt="IMG-CyberChef를 사용한 복호화-20240919173949065" style="zoom:80%;" />

password와 salt 파라미터에 전달되는 값을 역추적합니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919174332346.png" alt="IMG-CyberChef를 사용한 복호화-20240919174332346" style="zoom:80%;" />

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919174435136.png" alt="IMG-CyberChef를 사용한 복호화-20240919174435136" style="zoom:80%;" />

password에는 TEcGeTTkKXPrijmN.XqqDBwjaELqXAZq가 전달되는 것이 확인되었으며, Base64로 인코딩되어 있는 것 같은 문자열입니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919174545149.png" alt="IMG-CyberChef를 사용한 복호화-20240919174545149" style="zoom:80%;" />

salt에는 TEcGeTTkKXPrijmN.QBmUzntuXqvI라는 바이트 열이 전달됩니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919175228379.png" alt="IMG-CyberChef를 사용한 복호화-20240919175228379" style="zoom:80%;" />

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919175253783.png" alt="IMG-CyberChef를 사용한 복호화-20240919175253783" style="zoom:80%;" />

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919175422668.png" alt="IMG-CyberChef를 사용한 복호화-20240919175422668" style="zoom: 67%;" />

해당 정보를 토대로 CyberChef에서 PBKDF2 알고리즘을 실행하면 256bit(= 32byte) 키를 획득할 수 있습니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919175505140.png" alt="IMG-CyberChef를 사용한 복호화-20240919175505140" style="zoom:67%;" />

### ▪ <u>IV 구하기</u>

AES Key를 구한 이후에는 IV를 구해야 합니다. 코드를 확인해보면 qRHqCFYVDfrq 함수에 전달된 값의 첫 16 bytes를 사용하는 것을 알 수 있습니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919180210079.png" alt="IMG-CyberChef를 사용한 복호화-20240919180210079" style="zoom:80%;" />

qRHqCFYVDfrq 함수에 전달되는 인수를 역추적 해보면 base64 디코딩된 문자열이 전달되는 것이 확인 가능합니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919180711065.png" alt="IMG-CyberChef를 사용한 복호화-20240919180711065" style="zoom:80%;" />

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919185612732.png" alt="IMG-CyberChef를 사용한 복호화-20240919185612732" style="zoom:80%;" />

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919180742547.png" alt="IMG-CyberChef를 사용한 복호화-20240919180742547" style="zoom:80%;" />

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919180802653.png" alt="IMG-CyberChef를 사용한 복호화-20240919180802653" style="zoom:80%;" />

확인한 base64 문자열을 CyberChef 디코딩하여 첫 16 bytes를 구해 IV로 사용합니다. 뒷 부분은 AES로 암호화된 데이터 입니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919200851981.png" alt="IMG-CyberChef를 사용한 복호화-20240919200851981" style="zoom:67%;" />

### ▪ <u>AES 복호화</u>

앞서 구한 정보와 CyberChef를 사용하여 뒷 부분 데이터를 AES 복호화합니다. 쓰레기 값 뒤에 악성 도메인 확인이 가능합니다.

<img src="../images/2024-12-22-CyberChef-Malware-Analysis-Guide/IMG-CyberChef를 사용한 복호화-20240919201046899.png" alt="IMG-CyberChef를 사용한 복호화-20240919201046899" style="zoom:67%;" />